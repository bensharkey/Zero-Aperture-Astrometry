{% extends "base.html" %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h3 class="mb-0">ADES Astrometry File Upload</h3>
        {% if current_filename %}
            <span class="badge bg-dark">Current file: {{ current_filename }}</span>
        {% endif %}
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data" class="mb-4">
            <div class="mb-3">
                <label for="file" class="form-label">Choose a file to analyze:</label>
                <input type="file" class="form-control" name="file" id="file" 
                       accept=".psv,.xml" required>
                <div class="form-text">
                    Supported formats: PSV, XML
                </div>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-upload me-2"></i>Upload and Analyze
            </button>
        </form>

        {% set flashes = get_flashed_messages(with_categories=true) %}
        {% if flashes %}
            {% for category, message in flashes if category == 'global' %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% if error %}
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ error }}
            </div>
        {% endif %}
    </div>
</div>

{% if available_obstimes %}
<div class="card h-100 shadow-sm mt-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Select obstime group to analyze</h5>
    </div>
    <div class="card-body">
        {% if flashes %}
            {% for category, message in flashes if category == 'group' %}
                <div class="alert alert-info alert-dismissible fade show mb-3" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
        <form method="post" action="{{ url_for('main.select_group') }}" class="row g-2 align-items-end">
            <div class="col-sm-8">
                <select class="form-select" id="selected_obstime" name="selected_obstime">
                    <option value="">-- None --</option>
                    {% for t in available_obstimes %}
                        <option value="{{ t }}" {% if selected_obstime is not none and (t|string) == (selected_obstime|string) %}selected{% endif %}>
                            {{ t }}{% if obstime_counts and obstime_counts.get(t) %} ({{ obstime_counts.get(t) }}){% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-sm-4">
                <button type="submit" class="btn btn-primary w-100">Choose Group</button>
            </div>
        </form>
    </div>
</div>
{% endif %}


{% if selected_obstime %}
<div class="alert alert-info mt-3">
    <i class="bi bi-info-circle me-2"></i>
    Selected obstime: <strong>{{ selected_obstime }}</strong>
    {% if selected_count is not none %}
    <span class="badge bg-secondary ms-2">{{ selected_count }} rows</span>
    {% endif %}
    <form method="post" action="{{ url_for('main.select_group') }}" class="d-inline ms-2">
        <input type="hidden" name="selected_obstime" value="">
        <button class="btn btn-sm btn-outline-secondary">Clear</button>
    </form>
    </div>
{% endif %}

{% if selected_rows %}
<div class="card h-100 shadow-sm mt-3">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Manage Selected obstime Group</h5>
        <div>
            <form method="post" action="{{ url_for('main.clear_exclusions') }}" class="d-inline">
                <input type="hidden" name="obstime" value="{{ selected_obstime }}">
                <button type="submit" class="btn btn-sm btn-outline-danger">Clear Exclusions</button>
            </form>
        </div>
    </div>
    <div class="card-body">
        {# Messages #}
        {% if flashes %}
            {% for category, message in flashes if category == 'exclusions' %}
                <div class="alert alert-info alert-dismissible fade show mb-2" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
        <form method="post" action="{{ url_for('main.update_exclusions') }}">
            <input type="hidden" name="obstime" value="{{ selected_obstime }}">
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover align-middle">
                    <thead>
                        <tr>
                            <th style="width: 70px;">Select Aperture</th>
                            <th style="width: 90px;">Exclude?</th>
                            {% for col in selected_columns %}
                                <th>{{ col }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in selected_rows %}
                        <tr>
                            <td>
                                <input class="form-check-input" type="radio" name="selected_id" value="{{ row['_row_id'] }}" {% if picked_id and (row['_row_id']|string) == (picked_id|string) %}checked{% endif %}>
                            </td>
                            <td>
                                <input class="form-check-input" type="checkbox" name="exclude_id" value="{{ row['_row_id'] }}" {% if row['_row_id'] in excluded_ids %}checked{% endif %}>
                            </td>
                            {% for col in selected_columns %}
                                <td>{{ row[col] }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="mt-2 d-flex gap-2">
                <button type="submit" class="btn btn-primary">Update Fit</button>
            </div>
        </form>
        <div class="form-text mt-2">Use "Select Aperture" to choose the entry which matches the stellar catalog extraction aperture (or PSF) size used in fitting the astrometric reference frame. Use "Exclude?" to remove entries from linear fits. Supports up to 50 entries per time group.</div>
    </div>
    </div>
{% endif %}

{% if selected_df_html %}
<div class="card h-100 shadow-sm mt-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">Derived Linear Correction</h5>
    </div>
    {% if plot_urls %}
    <div class="card-body plot-container">
        {# Plot-specific messages #}
        {% if flashes %}
            {% for category, message in flashes if category == 'plot' %}
                <div class="alert alert-info alert-dismissible fade show mb-2" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
        <div class="row">
            <div class="col-md-12 text-center mb-3">
                <img src="{{ plot_urls['coords_photAp'] }}" class="img-fluid border rounded" alt="RA/Dec vs photAp">
                <div class="mt-2">RA/Dec vs photAp</div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

{% if selected_rows %}
<form id="derived_form" method="post" action="{{ url_for('main.select_single_entry') }}" class="mt-3">
    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-success">Store Above Fit for Download?</button>
    </div>
    <div class="form-text mt-2">Will create an ADES entry with zero-aperture correction applied to the "Picked" entry as indicated above. Inspect and approve below before downloading.  </div>
</form>
{% endif %}

{% if derived_rows is not none %}
<div class="card h-100 shadow-sm mt-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Derived Astrometric Correction</h5>
        <div class="d-flex gap-2">
            <form method="post" action="{{ url_for('main.clear_derived') }}" class="d-inline">
                <button type="submit" class="btn btn-sm btn-outline-danger">Clear All</button>
            </form>
            {% if derived_rows %}
                <a class="btn btn-sm btn-success" href="{{ url_for('main.download_derived') }}">Download PSV</a>
                <a class="btn btn-sm btn-outline-success" href="{{ url_for('main.download_derived_xml') }}">Download XML</a>
            {% else %}
                <button class="btn btn-sm btn-success" type="button" disabled title="No derived rows yet">Download PSV (|)</button>
                <button class="btn btn-sm btn-outline-success" type="button" disabled title="No derived rows yet">Download XML</button>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        {# Derived-specific messages (also visible here) #}
        {% if flashes %}
            {% for category, message in flashes if category == 'derived' %}
                <div class="alert alert-info alert-dismissible fade show mb-2" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
        {% if derived_rows %}
            {% set cols = original_columns if original_columns else derived_columns %}
            <form method="post" action="{{ url_for('main.delete_derived') }}">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover align-middle">
                        <thead>
                            <tr>
                                <th style="width: 70px;">Delete</th>
                                <th style="width: 70px;">#</th>
                                {% for col in cols %}
                                    <th>{{ col }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in derived_rows %}
                            <tr>
                                <td>
                                    <input class="form-check-input" type="checkbox" name="delete_idx" value="{{ loop.index0 }}">
                                </td>
                                <td>{{ loop.index0 }}</td>
                                {% for col in cols %}
                                    <td>{{ row.get(col) }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <button type="submit" class="btn btn-outline-primary">Delete Selected</button>
            </form>
        {% else %}
            <div class="text-muted">No derived entries yet. Use "Create Derived Entry" above to add one.</div>
        {% endif %}
    </div>
</div>
{% endif %}

<style>
    .table {
        font-size: 0.9rem;
    }
    .table th {
        background-color: #f8f9fa;
        white-space: nowrap;
    }
    pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        margin-bottom: 0;
    }
    .card {
        border: none;
        border-radius: 0.5rem;
    }
    .card-header {
        border-radius: 0.5rem 0.5rem 0 0 !important;
    }
</style>

<!-- Add Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
{% endblock %}
